<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artificial Sunrise</title>
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Artificial Sunrise</h1>
        </div>

        <form method="POST" action="/settings">
            <div class="section">
                <h2 class="section-title">Farbeinstellungen</h2>
                <div class="form-group">
                    <label>Rot</label>
                    <input type="range" name="red" min="0" max="255" value="%RED%">
                    <span class="text-muted">Wert: <span id="red-val">%RED%</span></span>
                </div>
                <div class="form-group">
                    <label>Grün</label>
                    <input type="range" name="green" min="0" max="255" value="%GREEN%">
                    <span class="text-muted">Wert: <span id="green-val">%GREEN%</span></span>
                </div>
                <div class="form-group">
                    <label>Blau</label>
                    <input type="range" name="blue" min="0" max="255" value="%BLUE%">
                    <span class="text-muted">Wert: <span id="blue-val">%BLUE%</span></span>
                </div>
            </div>

            <div class="form-group">
                <label>Licht aktivieren
                    <label class="switch">
                        <input type="checkbox" id="light_preview" name="light_preview" value="1" %LIGHT_PREVIEW%>
                        <span class="slider"></span>
                    </label>
                </label>
            </div>

            <div class="form-group">
                <label>Hardwareschalter deaktivieren
                    <label class="switch">
                        <input type="checkbox" name="disable_hardware_switches" id="disable_hardware_switches" value="1"
                            %DISABLE_SETTINGS%>
                        <span class="slider"></span>
                    </label>
                </label>
            </div>

            <div class="section">
                <h2 class="section-title">Alarmeinstellungen</h2>
                <div class="grid">
                    <div class="form-group">
                        <label>Sonnenaufgang [min]</label>
                        <input type="number" name="duration_minutes" value="%DURATION_MINUTES%" min="1" max="120">
                    </div>
                    <div class="form-group">
                        <label>Nachher [min]</label>
                        <input type="number" name="duration_on_brightest" value="%DURATION_ON_BRIGHTEST%" min="1"
                            max="120">
                    </div>
                    <div class="form-group">
                        <label>Alarm Stunde</label>
                        <input type="number" name="alarm_hour" value="%ALARM_HOUR%" min="0" max="23">
                    </div>
                    <div class="form-group">
                        <label>Alarm Minute</label>
                        <input type="number" name="alarm_minute" value="%ALARM_MINUTE%" min="0" max="59">
                    </div>
                </div>

                <div class="form-group">
                    <label>Alarm aktiviert
                        <label class="switch">
                            <input type="checkbox" id="enabled" name="enabled" value="1" %ENABLED%>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
            </div>
        </form>
    </div>

    <script>
        ['red', 'green', 'blue'].forEach(name => {
            const slider = document.querySelector(`input[name="${name}"]`);
            const valSpan = document.getElementById(`${name}-val`);
            if (slider && valSpan) {
                slider.oninput = () => valSpan.textContent = slider.value;
            }
        });

        // Switch auto update
        let lastSwitchState = { enabled: null, light_preview: null };

        function refreshSwitchStates() {
            fetch("/settings")
                .then(r => r.json())
                .then(data => {
                    if (data.enabled !== lastSwitchState.enabled || data.light_preview !== lastSwitchState.light_preview) {
                        updateSwitches(data);
                        lastSwitchState.enabled = data.enabled;
                        lastSwitchState.light_preview = data.light_preview;
                    }
                })
                .catch(err => console.error("Update failed", err));
        }

        function updateSwitches(data) {
            document.querySelector("#enabled").checked = data.enabled;
            document.querySelector("#light_preview").checked = data.light_preview;
        }

        setInterval(refreshSwitchStates, 500);
        window.addEventListener("load", refreshSwitchStates);

        // Set Switches disabled if hardware switches are enabled
        function toggleDisableSettings(disabled) {
            document.querySelectorAll('input[type="checkbox"]').forEach(el => {
                if (el.id !== "disable_hardware_switches") {
                    const label = el.closest("label.switch");
                    if (label) {
                        if (disabled) {
                            el.disabled = false;
                            label.classList.remove("input-disabled");
                        } else {
                            el.disabled = true;
                            label.classList.add("input-disabled");
                        }
                    }
                }
            });
        }

        document.getElementById("disable_hardware_switches").addEventListener("change", e => {
            toggleDisableSettings(e.target.checked);
        });

        window.addEventListener("load", () => {
            toggleDisableSettings(document.getElementById("disable_hardware_switches").checked);
        });

        // Funktion: alle aktuellen Einstellungen posten
        function updateSetting() {
            const params = new URLSearchParams();

            ['red', 'green', 'blue', 'duration_minutes', 'duration_on_brightest', 'alarm_hour', 'alarm_minute', 'enabled', 'light_preview', 'disable_hardware_switches'].forEach(n => {
                const el = document.querySelector(`[name="${n}"]`);
                if (el) {
                    params.append(n, el.type === "checkbox" ? (el.checked ? "1" : "0") : el.value);
                }
            });

            fetch("/settings", {
                method: "POST",
                body: params,
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            }).catch(err => console.error("Failed to update setting:", err));
        }

        // Slider-Inputs: sofort speichern bei Änderung
        ['red', 'green', 'blue'].forEach(name => {
            const slider = document.querySelector(`input[name="${name}"]`);
            const valSpan = document.getElementById(`${name}-val`);
            if (slider && valSpan) {
                slider.oninput = () => {
                    valSpan.textContent = slider.value;
                };
                slider.onchange = updateSetting;
            }
        });

        // Number-Inputs: sofort speichern bei Änderung
        ['duration_minutes', 'duration_on_brightest', 'alarm_hour', 'alarm_minute'].forEach(name => {
            const input = document.querySelector(`input[name="${name}"]`);
            if (input) {
                input.onchange = updateSetting;
            }
        });

        // Switches: sofort speichern bei Änderung
        ['enabled', 'light_preview', 'disable_hardware_switches'].forEach(name => {
            const checkbox = document.querySelector(`input[name="${name}"]`);
            if (checkbox) {
                checkbox.onchange = updateSetting;
            }
        });
    </script>
</body>

</html>